!function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=7)}([function(e,t){"object"!=typeof globalThis&&(Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__)},function(e,t,n){"use strict";n.r(t),n.d(t,"version",(function(){return r})),n.d(t,"VERSION",(function(){return s})),n.d(t,"atob",(function(){return R})),n.d(t,"atobPolyfill",(function(){return j})),n.d(t,"btoa",(function(){return A})),n.d(t,"btoaPolyfill",(function(){return m})),n.d(t,"fromBase64",(function(){return M})),n.d(t,"toBase64",(function(){return T})),n.d(t,"utob",(function(){return C})),n.d(t,"encode",(function(){return T})),n.d(t,"encodeURI",(function(){return _})),n.d(t,"encodeURL",(function(){return _})),n.d(t,"btou",(function(){return x})),n.d(t,"decode",(function(){return M})),n.d(t,"isValid",(function(){return I})),n.d(t,"fromUint8Array",(function(){return b})),n.d(t,"toUint8Array",(function(){return k})),n.d(t,"extendString",(function(){return K})),n.d(t,"extendUint8Array",(function(){return F})),n.d(t,"extendBuiltins",(function(){return D})),n.d(t,"Base64",(function(){return N}));const r="3.7.2",s=r,i="function"==typeof atob,o="function"==typeof btoa,a="function"==typeof Buffer,c="function"==typeof TextDecoder?new TextDecoder:void 0,u="function"==typeof TextEncoder?new TextEncoder:void 0,h=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),l=(e=>{let t={};return e.forEach((e,n)=>t[e]=n),t})(h),d=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,f=String.fromCharCode.bind(String),p="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):(e,t=(e=>e))=>new Uint8Array(Array.prototype.slice.call(e,0).map(t)),g=e=>e.replace(/=/g,"").replace(/[+\/]/g,e=>"+"==e?"-":"_"),y=e=>e.replace(/[^A-Za-z0-9\+\/]/g,""),m=e=>{let t,n,r,s,i="";const o=e.length%3;for(let o=0;o<e.length;){if((n=e.charCodeAt(o++))>255||(r=e.charCodeAt(o++))>255||(s=e.charCodeAt(o++))>255)throw new TypeError("invalid character found");t=n<<16|r<<8|s,i+=h[t>>18&63]+h[t>>12&63]+h[t>>6&63]+h[63&t]}return o?i.slice(0,o-3)+"===".substring(o):i},A=o?e=>btoa(e):a?e=>Buffer.from(e,"binary").toString("base64"):m,w=a?e=>Buffer.from(e).toString("base64"):e=>{let t=[];for(let n=0,r=e.length;n<r;n+=4096)t.push(f.apply(null,e.subarray(n,n+4096)));return A(t.join(""))},b=(e,t=!1)=>t?g(w(e)):w(e),S=e=>{if(e.length<2)return(t=e.charCodeAt(0))<128?e:t<2048?f(192|t>>>6)+f(128|63&t):f(224|t>>>12&15)+f(128|t>>>6&63)+f(128|63&t);var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return f(240|t>>>18&7)+f(128|t>>>12&63)+f(128|t>>>6&63)+f(128|63&t)},v=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,C=e=>e.replace(v,S),E=a?e=>Buffer.from(e,"utf8").toString("base64"):u?e=>w(u.encode(e)):e=>A(C(e)),T=(e,t=!1)=>t?g(E(e)):E(e),_=e=>T(e,!0),O=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,P=e=>{switch(e.length){case 4:var t=((7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3))-65536;return f(55296+(t>>>10))+f(56320+(1023&t));case 3:return f((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return f((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},x=e=>e.replace(O,P),j=e=>{if(e=e.replace(/\s+/g,""),!d.test(e))throw new TypeError("malformed base64.");e+="==".slice(2-(3&e.length));let t,n,r,s="";for(let i=0;i<e.length;)t=l[e.charAt(i++)]<<18|l[e.charAt(i++)]<<12|(n=l[e.charAt(i++)])<<6|(r=l[e.charAt(i++)]),s+=64===n?f(t>>16&255):64===r?f(t>>16&255,t>>8&255):f(t>>16&255,t>>8&255,255&t);return s},R=i?e=>atob(y(e)):a?e=>Buffer.from(e,"base64").toString("binary"):j,H=a?e=>p(Buffer.from(e,"base64")):e=>p(R(e),e=>e.charCodeAt(0)),k=e=>H(B(e)),U=a?e=>Buffer.from(e,"base64").toString("utf8"):c?e=>c.decode(H(e)):e=>x(R(e)),B=e=>y(e.replace(/[-_]/g,e=>"-"==e?"+":"/")),M=e=>U(B(e)),I=e=>{if("string"!=typeof e)return!1;const t=e.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(t)||!/[^\s0-9a-zA-Z\-_]/.test(t)},z=e=>({value:e,enumerable:!1,writable:!0,configurable:!0}),K=function(){const e=(e,t)=>Object.defineProperty(String.prototype,e,z(t));e("fromBase64",(function(){return M(this)})),e("toBase64",(function(e){return T(this,e)})),e("toBase64URI",(function(){return T(this,!0)})),e("toBase64URL",(function(){return T(this,!0)})),e("toUint8Array",(function(){return k(this)}))},F=function(){const e=(e,t)=>Object.defineProperty(Uint8Array.prototype,e,z(t));e("toBase64",(function(e){return b(this,e)})),e("toBase64URI",(function(){return b(this,!0)})),e("toBase64URL",(function(){return b(this,!0)}))},D=()=>{K(),F()},N={version:r,VERSION:s,atob:R,atobPolyfill:j,btoa:A,btoaPolyfill:m,fromBase64:M,toBase64:T,encode:T,encodeURI:_,encodeURL:_,utob:C,btou:x,decode:M,isValid:I,fromUint8Array:b,toUint8Array:k,extendString:K,extendUint8Array:F,extendBuiltins:D}},function(e,t){e.exports={Router:({base:e="",routes:t=[]}={})=>({__proto__:new Proxy({},{get:(n,r,s)=>(n,...i)=>t.push([r.toUpperCase(),RegExp(`^${(e+n).replace(/(\/?)\*/g,"($1.*)?").replace(/\/$/,"").replace(/:(\w+)(\?)?(\.)?/g,"$2(?<$1>[^/]+)$2$3").replace(/\.(?=[\w(])/,"\\.")}/*$`),i])&&s}),routes:t,async handle(e,...n){let r,s,i=new URL(e.url);for(var[o,a,c]of(e.query=Object.fromEntries(i.searchParams),t))if((o===e.method||"ALL"===o)&&(s=i.pathname.match(a)))for(var u of(e.params=s.groups,c))if(void 0!==(r=await u(e.proxy||e,...n)))return r}})}},function(e,t,n){const{getToken:r,getTokenFromGCPServiceAccount:s}=n(5);e.exports={getToken:r,getTokenFromGCPServiceAccount:s}},function(e,t,n){!function(e){"use strict";
/**
   * @license MIT <https://opensource.org/licenses/MIT>
   * @copyright Michael Hart 2018
   */const t=new TextEncoder,n={appstream2:"appstream",cloudhsmv2:"cloudhsm",email:"ses",marketplace:"aws-marketplace",mobile:"AWSMobileHubService",pinpoint:"mobiletargeting",queue:"sqs","git-codecommit":"codecommit","mturk-requester-sandbox":"mturk-requester","personalize-runtime":"personalize"},r=["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id","range","connection"];class s{constructor({method:e,url:t,headers:s,body:i,accessKeyId:o,secretAccessKey:a,sessionToken:u,service:h,region:l,cache:d,datetime:f,signQuery:p,appendSessionToken:g,allHeaders:y,singleEncode:m}){if(null==t)throw new TypeError("url is a required option");if(null==o)throw new TypeError("accessKeyId is a required option");if(null==a)throw new TypeError("secretAccessKey is a required option");let A,w;this.method=e||(i?"POST":"GET"),this.url=new URL(t),this.headers=new Headers(s||{}),this.body=i,this.accessKeyId=o,this.secretAccessKey=a,this.sessionToken=u,h&&l||([A,w]=function(e,t){const{hostname:r,pathname:s}=e,i=r.replace("dualstack.","").match(/([^.]+)\.(?:([^.]*)\.)?amazonaws\.com(?:\.cn)?$/);let[o,a]=(i||["",""]).slice(1,3);if("us-gov"===a)a="us-gov-west-1";else if("s3"===a||"s3-accelerate"===a)a="us-east-1",o="s3";else if("iot"===o)o=r.startsWith("iot.")?"execute-api":r.startsWith("data.jobs.iot.")?"iot-jobs-data":"/mqtt"===s?"iotdevicegateway":"iotdata";else if("autoscaling"===o){const e=(t.get("X-Amz-Target")||"").split(".")[0];"AnyScaleFrontendService"===e?o="application-autoscaling":"AnyScaleScalingPlannerFrontendService"===e&&(o="autoscaling-plans")}else null==a&&o.startsWith("s3-")?(a=o.slice(3).replace(/^fips-|^external-1/,""),o="s3"):o.endsWith("-fips")?o=o.slice(0,-5):a&&/-\d$/.test(o)&&!/-\d$/.test(a)&&([o,a]=[a,o]);return[n[o]||o,a]}(this.url,this.headers)),this.service=h||A||"",this.region=l||w||"us-east-1",this.cache=d||new Map,this.datetime=f||(new Date).toISOString().replace(/[:-]|\.\d{3}/g,""),this.signQuery=p,this.appendSessionToken=g||"iotdevicegateway"===this.service,this.headers.delete("Host");const b=this.signQuery?this.url.searchParams:this.headers;if("s3"!==this.service||this.headers.has("X-Amz-Content-Sha256")||this.headers.set("X-Amz-Content-Sha256","UNSIGNED-PAYLOAD"),b.set("X-Amz-Date",this.datetime),this.sessionToken&&!this.appendSessionToken&&b.set("X-Amz-Security-Token",this.sessionToken),this.signableHeaders=["host",...this.headers.keys()].filter(e=>y||!r.includes(e)).sort(),this.signedHeaders=this.signableHeaders.join(";"),this.canonicalHeaders=this.signableHeaders.map(e=>e+":"+("host"===e?this.url.host:(this.headers.get(e)||"").replace(/\s+/g," "))).join("\n"),this.credentialString=[this.datetime.slice(0,8),this.region,this.service,"aws4_request"].join("/"),this.signQuery&&("s3"!==this.service||b.has("X-Amz-Expires")||b.set("X-Amz-Expires","86400"),b.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),b.set("X-Amz-Credential",this.accessKeyId+"/"+this.credentialString),b.set("X-Amz-SignedHeaders",this.signedHeaders)),"s3"===this.service)try{this.encodedPath=decodeURIComponent(this.url.pathname.replace(/\+/g," "))}catch(e){this.encodedPath=this.url.pathname}else this.encodedPath=this.url.pathname.replace(/\/+/g,"/");m||(this.encodedPath=encodeURIComponent(this.encodedPath).replace(/%2F/g,"/")),this.encodedPath=c(this.encodedPath);const S=new Set;this.encodedSearch=[...this.url.searchParams].filter(([e])=>{if(!e)return!1;if("s3"===this.service){if(S.has(e))return!1;S.add(e)}return!0}).map(e=>e.map(e=>c(encodeURIComponent(e)))).sort(([e,t],[n,r])=>e<n?-1:e>n?1:t<r?-1:t>r?1:0).map(e=>e.join("=")).join("&")}async sign(){return this.signQuery?(this.url.searchParams.set("X-Amz-Signature",await this.signature()),this.sessionToken&&this.appendSessionToken&&this.url.searchParams.set("X-Amz-Security-Token",this.sessionToken)):this.headers.set("Authorization",await this.authHeader()),{method:this.method,url:this.url,headers:this.headers,body:this.body}}async authHeader(){return["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+this.credentialString,"SignedHeaders="+this.signedHeaders,"Signature="+await this.signature()].join(", ")}async signature(){const e=this.datetime.slice(0,8),t=[this.secretAccessKey,e,this.region,this.service].join();let n=this.cache.get(t);if(!n){const r=await i("AWS4"+this.secretAccessKey,e),s=await i(r,this.region),o=await i(s,this.service);n=await i(o,"aws4_request"),this.cache.set(t,n)}return a(await i(n,await this.stringToSign()))}async stringToSign(){return["AWS4-HMAC-SHA256",this.datetime,this.credentialString,a(await o(await this.canonicalString()))].join("\n")}async canonicalString(){return[this.method.toUpperCase(),this.encodedPath,this.encodedSearch,this.canonicalHeaders+"\n",this.signedHeaders,await this.hexBodyHash()].join("\n")}async hexBodyHash(){let e=this.headers.get("X-Amz-Content-Sha256");if(null==e){if(this.body&&"string"!=typeof this.body&&!("byteLength"in this.body))throw new Error("body must be a string, ArrayBuffer or ArrayBufferView, unless you include the X-Amz-Content-Sha256 header");e=a(await o(this.body||""))}return e}}async function i(e,n){const r=await crypto.subtle.importKey("raw","string"==typeof e?t.encode(e):e,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return crypto.subtle.sign("HMAC",r,t.encode(n))}async function o(e){return crypto.subtle.digest("SHA-256","string"==typeof e?t.encode(e):e)}function a(e){return Array.prototype.map.call(new Uint8Array(e),e=>("0"+e.toString(16)).slice(-2)).join("")}function c(e){return e.replace(/[!'()*]/g,e=>"%"+e.charCodeAt(0).toString(16).toUpperCase())}e.AwsClient=class{constructor({accessKeyId:e,secretAccessKey:t,sessionToken:n,service:r,region:s,cache:i,retries:o,initRetryMs:a}){if(null==e)throw new TypeError("accessKeyId is a required option");if(null==t)throw new TypeError("secretAccessKey is a required option");this.accessKeyId=e,this.secretAccessKey=t,this.sessionToken=n,this.service=r,this.region=s,this.cache=i||new Map,this.retries=null!=o?o:10,this.initRetryMs=a||50}async sign(e,t){if(e instanceof Request){const{method:n,url:r,headers:s,body:i}=e;null==(t=Object.assign({method:n,url:r,headers:s},t)).body&&s.has("Content-Type")&&(t.body=null!=i&&s.has("X-Amz-Content-Sha256")?i:await e.clone().arrayBuffer()),e=r}const n=new s(Object.assign({url:e},t,this,t&&t.aws)),r=Object.assign({},t,await n.sign());return delete r.aws,new Request(r.url.toString(),r)}async fetch(e,t){for(let n=0;n<=this.retries;n++){const r=fetch(await this.sign(e,t));if(n===this.retries)return r;const s=await r;if(s.status<500&&429!==s.status)return s;await new Promise(e=>setTimeout(e,Math.random()*this.initRetryMs*Math.pow(2,n)))}throw new Error("An unknown error occurred, ensure retries is not negative")}},e.AwsV4Signer=s,Object.defineProperty(e,"__esModule",{value:!0})}(t)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getTokenFromGCPServiceAccount=t.getToken=t.getHeader=t.algorithms=void 0;var r=n(6);n(0);var s=n(1);const i={RS256:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},ES256:{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}}};t.algorithms=i;const o=(e,t)=>({...t,alg:e,typ:"JWT"});t.getHeader=o;const a=async({privateKeyPEM:e,payload:t,alg:n="RS256",cryptoImpl:a=null,headerAdditions:c={}})=>{const u=i[n];if(!u)throw new Error(`@sagi.io/workers-jwt: Unsupported algorithm ${n}.`);if(!globalThis.crypto){if(!a)throw new Error("@sagi.io/workers-jwt: No crypto nor cryptoImpl were found.");globalThis.crypto=a}const h=(0,r.getDERfromPEM)(e),l=await crypto.subtle.importKey("pkcs8",h,u,!1,["sign"]),d=o(n,c),f=(0,r.getEncodedMessage)(d,t),p=(0,r.str2ab)(f),g=await crypto.subtle.sign(u,l,p),y=new Uint8Array(g);return`${f}.${s.Base64.fromUint8Array(y,!0)}`};t.getToken=a;t.getTokenFromGCPServiceAccount=async({serviceAccountJSON:e,aud:t,alg:n="RS256",cryptoImpl:r=null,expiredAfter:s=3600,headerAdditions:i={},payloadAdditions:c={}})=>{const{client_email:u,private_key_id:h,private_key:l}=e;Object.assign(i,{kid:h});o(n,i);const d=parseInt(Date.now()/1e3),f={aud:t,iss:u,sub:u,iat:d,exp:d+s,...c};return a({privateKeyPEM:l,payload:f,alg:n,headerAdditions:i,cryptoImpl:r})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEncodedMessage=t.b64encodeJSON=t.getDERfromPEM=t.str2ab=void 0,n(0);var r=n(1);const s=e=>{const t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let t=0,r=e.length;t<r;t++)n[t]=e.charCodeAt(t);return t};t.str2ab=s;t.getDERfromPEM=e=>{const t=e.trim().split("\n").slice(1,-1).join("");return s(r.Base64.atob(t))};const i=e=>r.Base64.encode(JSON.stringify(e),!0);t.b64encodeJSON=i;t.getEncodedMessage=(e,t)=>`${i(e)}.${i(t)}`},function(e,t,n){"use strict";n.r(t);var r=n(2),s=n(3);async function i({limit:e,offset:t}){let n;e&&(n="A2:H"+(1+e)),t&&(n="A"+(2+t)+":H");const r={Authorization:"Bearer "+await Object(s.getTokenFromGCPServiceAccount)({serviceAccountJSON:JSON.parse(SERVICE_ACCOUNT_JSON),aud:GOOGLE_TOKEN_AUD})},i="https://sheets.googleapis.com/v4/spreadsheets/"+GOOGLE_SPREADSHEET_ID+"/values/"+GOOGLE_WORKSHEET_TITLE+"!"+n,o=await fetch(i,{headers:r}),{values:a}=await o.json();let c=[];if(a){var u=a.filter(e=>e.length>0);c=u||[]}return c}var o=n(4);const a=Object(r.Router)(),c=new o.AwsClient({accessKeyId:AWS_ACCESS_KEY_ID,secretAccessKey:AWS_SECRET_ACCESS_KEY}),u="https://lambda.ap-southeast-1.amazonaws.com/2015-03-31/functions/new-age-lambda/invocations",h=caches.default,l=async()=>{let e;try{e=await c.fetch(u,{method:"POST"}),e=new Response(e.body,e),e.headers.append("Cache-Control","s-maxage=771379200"),h.put(u,e.clone())}catch(e){console.log("AWS API RES ERROR",e)}const t=await e.json();return JSON.parse(t.body)},d=async()=>{let e,t=await h.match(u);if(t){const n=await t.json();e=JSON.parse(n.body)}else e=await l();return e},f=async e=>{const t=await d();e.cachedMeta=t};async function p(e,t){return await Promise.all(e.filter(e=>e&&"1"===e[5]&&e[0]).map(async e=>{let n;if("-1"!==e[7]){const r=await async function(e,t){console.log("THE CACHE",t[0]);let n=t[e];if(console.log("FOUND",n),void 0===n){const t=await l();n=t[e]}return n}(e[0]+".png",t);console.log("IMage meta","KEY"+e[0],r);const{dimensions:{width:s,height:i},blurhash:o}=r;n={imageurl:"s3://gvh-library/"+e[0]+".png",width:s,height:i,blurhash:o}}return{title:e[1],number:e[0],imageurl:n?n.imageurl:null,category:e[2]||"No category",series:e[3]||"No series",language:e[4]||"Language undefined",inventory:e[5],comment:e[6],width:n?n.width:null,height:n?n.height:null,blurhash:n?n.blurhash:null}}))}a.get("/test",async()=>{const e=await d();return new Response(e,{headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}),a.get("/initial-books",f,(async function(e,t){var n=await i({limit:30});return 0!==n.length&&(n=await p(n,e.cachedMeta)),new Response(JSON.stringify(n),{headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})})),a.get("/books",f,(async function(e,t){var n=await i({offset:30});return console.log("ROWS",n),0!==n.length&&(n=await p(n,e.cachedMeta)),new Response(JSON.stringify(n),{headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})})),a.all("*",()=>new Response("404, not found!",{status:404})),addEventListener("fetch",e=>{e.respondWith(a.handle(e.request))})}]);